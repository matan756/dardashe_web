<script>
  const SUPABASE_URL = "https://auth.dardashe.co.il";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndxZ253Y2x1b2Rtd3N6Z2p0b25hIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDM3NzkwMTUsImV4cCI6MjA1OTM1NTAxNX0.IHAdNJNTOvymdlrn9ZpS50US46HgiKkn6r6j7otOTDs";

  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const $ = (id) => document.getElementById(id);
  const statusEl = $("status");
  const formEl = $("form");
  const errorEl = $("error");
  const infoEl = $("info");
  const passEl = $("password");
  const confirmEl = $("confirm");
  const submitEl = $("submit");
  const toggle1 = $("toggle1");
  const toggle2 = $("toggle2");

  let didUpdate = false;

  function show(el) { el.classList.remove("hidden"); }
  function hide(el) { el.classList.add("hidden"); }
  function setStatus(msg) { statusEl.textContent = msg; }
  function setError(msg) { errorEl.textContent = msg; show(errorEl); }
  function clearError(){ errorEl.textContent = ""; hide(errorEl); }
  function setInfo(msg) { infoEl.textContent = msg; show(infoEl); }
  function clearInfo(){ infoEl.textContent = ""; hide(infoEl); }

  function parseParams() {
    const q = new URLSearchParams(location.search);
    const h = new URLSearchParams((location.hash || "").replace(/^#/, ""));
    return {
      code: q.get("code") || h.get("code"),
      access_token: q.get("access_token") || h.get("access_token"),
      refresh_token: q.get("refresh_token") || h.get("refresh_token"),
    };
  }

  function stripSecretsFromUrl() {
    const cleanUrl = location.origin + location.pathname;
    if (cleanUrl !== location.href) {
      history.replaceState(null, "", cleanUrl);
    }
  }

  function toggleInput(input, t) {
    const isPwd = input.type === "password";
    input.type = isPwd ? "text" : "password";
    t.textContent = isPwd ? "🙈" : "👁️";
  }

  toggle1.onclick = () => toggleInput(passEl, toggle1);
  toggle2.onclick = () => toggleInput(confirmEl, toggle2);

  (async () => {
    try {
      const params = parseParams();

      if (params.code) {
        await supabase.auth.exchangeCodeForSession(location.href);
      } else if (params.access_token && params.refresh_token) {
        await supabase.auth.setSession({
          access_token: params.access_token,
          refresh_token: params.refresh_token,
        });
      }

      const { data: { session } } = await supabase.auth.getSession();
      if (!session) {
        setStatus("לא נמצאו פרטי אימות. פתחו את הקישור מהאימייל שוב.");
        return;
      }

      stripSecretsFromUrl();

      setStatus("הכל מוכן, ניתן לעדכן סיסמה.");
      show(formEl);
    } catch (e) {
      console.error(e);
      setStatus("שגיאה בזיהוי. נסו שוב.");
    }
  })();

  submitEl.onclick = async () => {
    clearError(); clearInfo();

    if (didUpdate) {
      setError("כבר נעשה שימוש בקישור. פתחו קישור חדש מהאימייל אם צריך.");
      return;
    }

    const p = (passEl.value || "").trim(), c = (confirmEl.value || "").trim();
    if (!p || !c) return setError("נא למלא את שני השדות.");
    if (p.length < 6) return setError("הסיסמה צריכה להכיל לפחות 6 תווים.");
    if (p !== c) return setError("הסיסמאות אינן תואמות.");

    submitEl.disabled = true; submitEl.textContent = "מעדכן...";

    try {
      const { error } = await supabase.auth.updateUser({ password: p });
      if (error) {
        // ✅ catch same password error & show Hebrew message
        if (
          error.message.includes("same") ||
          error.message.includes("old password") ||
          error.message.includes("different")
        ) {
          throw new Error("הסיסמה שהזנת זהה לסיסמה הקודמת");
        }
        throw error;
      }

      didUpdate = true;

      try { await supabase.auth.signOut(); } catch {}

      setInfo("✅ הסיסמה עודכנה בהצלחה");
      setStatus("");
      hide(formEl);

      // ✅ Hide bottom message after success
      document.querySelector(".muted").textContent = "";
    } catch (e) {
      console.error(e);
      setError(e?.message || "אירעה שגיאה. נסו שוב.");
    } finally {
      if (!didUpdate) {
        submitEl.disabled = false; submitEl.textContent = "עדכון סיסמה";
      }
    }
  };
</script>
