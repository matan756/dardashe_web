<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />

  <!-- ✔ ANDROID-SAFE CSP -->
  <meta http-equiv="Content-Security-Policy"
        content="
          default-src 'self';
          script-src 'self' https://cdn.jsdelivr.net 'unsafe-inline' 'unsafe-eval';
          style-src 'self' 'unsafe-inline';
          img-src 'self' data: https://dardashe.co.il https://auth.dardashe.co.il;
          connect-src 'self'
                       https://wqgnwcluodmwszgjtona.supabase.co
                       https://wqgnwcluodmwszgjtona.supabase.co/*
                       wss://wqgnwcluodmwszgjtona.supabase.co
                       https://cdn.jsdelivr.net
                       https://cdn.jsdelivr.net/*;
        ">

  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>דַרְדַשֶה – שאלון פיילוט</title>

  <link rel="stylesheet" href="style.css" />

  <style>
    /* Optional: keep disabled button obvious */
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none !important;
    }

    #message {
      margin-top: 12px;
      font-size: 16px;
      font-weight: 600;
      text-align: center;
    }
  </style>
</head>

<body>
  <div class="page">
    <main class="container">

      <div class="logo">
        <img src="https://dardashe.co.il/app_logo.png" alt="לוגו דרדשה">
      </div>

      <h1>תודה על השתתפותכם בפיילוט של דרדשה!</h1>

      <p>
        אנחנו מעוניינים להכווין את פיתוח האפליקציה בהתאם למסקנות שלכם.<br>
        לכן, נשמח אם תוכלו לענות על השאלות הבאות:
      </p>

      <form id="feedbackForm">

        <div>
          <label for="q1">מה הייתם רוצים לשפר או לשנות בדרדשה?</label>
          <textarea id="q1" name="q1" placeholder="כתבו כאן..."></textarea>
        </div>

        <div>
          <label for="q2">האם יש פיצ'ר / סוג תרגיל שציפיתם למצוא באפליקציה ולא מצאתם? אם כן — מהו?</label>
          <textarea id="q2" name="q2" placeholder="כתבו כאן..."></textarea>
        </div>

        <div>
          <label for="q3">מה לדעתכם עובד טוב ותרצו שנמשיך לפתח?</label>
          <textarea id="q3" name="q3" placeholder="כתבו כאן..."></textarea>
        </div>

        <div>
          <label for="q4">הערות נוספות:</label>
          <textarea id="q4" name="q4" placeholder="כתבו כאן..."></textarea>
        </div>

        <button id="submitBtn" type="submit" disabled>שליחה</button>
        <div id="message"></div>
      </form>

    </main>
  </div>

  <!-- ✔ UMD SUPABASE — ANDROID SAFE -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js/dist/umd/supabase.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const supabase = window.supabase.createClient(
        "https://wqgnwcluodmwszgjtona.supabase.co",
        "sb_publishable_fNMgEK319mUQHpRTVjgtzg_Hymx2to6"
      );

      const form = document.getElementById("feedbackForm");
      const submitBtn = document.getElementById("submitBtn");
      const messageDiv = document.getElementById("message");

      const fields = [
        document.getElementById("q1"),
        document.getElementById("q2"),
        document.getElementById("q3"),
        document.getElementById("q4"),
      ];

      function hasAtLeastOneAnswer() {
        return fields.some(el => (el.value || "").trim().length > 0);
      }

      function updateButtonState() {
        submitBtn.disabled = !hasAtLeastOneAnswer();
      }

      // Enable button only when at least one field has content
      fields.forEach(el => {
        el.addEventListener("input", updateButtonState);
      });

      // initial state
      updateButtonState();

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        messageDiv.textContent = "";
        messageDiv.className = "";

        // Guard: must have at least one answer
        if (!hasAtLeastOneAnswer()) {
          submitBtn.disabled = true;
          return;
        }

        submitBtn.disabled = true;

        const payload = {
          q1: (fields[0].value || "").trim() || null,
          q2: (fields[1].value || "").trim() || null,
          q3: (fields[2].value || "").trim() || null,
          q4: (fields[3].value || "").trim() || null,
          source: "pilot-feedback-web",
        };

        try {
          const { error } = await supabase
            .from("pilot_feedback")
            .insert([payload]);

          if (error) throw error;

          form.reset();
          updateButtonState();

          messageDiv.className = "success";
          messageDiv.textContent = "המענה התקבל בהצלחה. תודה על תרומתך לשיפור האפליקציה!";

        } catch (err) {
          console.error("Supabase error:", err);
          messageDiv.className = "error";
          messageDiv.textContent = "שגיאה בשליחה, יש לנסות שוב מאוחר יותר.";
          updateButtonState(); // re-enable if there is still text
        } finally {
          // If form is empty after reset, button stays disabled.
          // If error and user still has content, updateButtonState will enable.
        }
      });
    });
  </script>
</body>
</html>
